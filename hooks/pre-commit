#!/bin/bash

source ~/.dotfiles/functions/bash_support.sh
source ~/.dotfiles/functions/git_support.sh

git_system && exit 0

exit_code=0

if [[ -f .eslintrc ]] || [[ -f .eslintrc.js ]]; then
  js_files=$(git_modified js jsx)
  if [[ ! -z $js_files ]]; then
    git_fake_auto_stash
    echodo node_modules/.bin/eslint $js_files || exit 1
    echodo node_modules/.bin/prettier-eslint --write $js_files
    git diff $js_files
    [[ -z "$(git diff $js_files)" ]] || exit 1
  fi
fi

if [[ -f .rubocop.yml ]]; then
  rb_files=$(git_modified rb jbuilder builder Gemfile)
  if [[ ! -z $rb_files ]]; then
    git_fake_auto_stash
    refactor_cops=$(bundle exec rubocop --show-cops | awk -F':' '/^[A-Z]|^  Severity: refactor/ {if($2==" refactor"){printf prev ","}else{prev=$1}}')
    [[ -z "$refactor_cops" ]] || refactor_cops="--except $refactor_cops"
    echodo bundle exec rubocop --parallel --force-exclusion --color $refactor_cops $rb_files || exit_code=1
  fi
fi

exit $exit_code
